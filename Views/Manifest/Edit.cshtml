@model SMS.Models.ViewModels.ManifestVM
@{
    ViewData["Title"] = "Edit Manifest";
    Layout = "~/Views/Shared/AdminLTE/_Layout.cshtml";
}

<div class="card shadow mb-4">
    <div class="card-header"><h6 class="m-0 font-weight-bold text-primary">Edit Manifest ID: @Model.GeneratedManifestId</h6></div>
    <div class="card-body">
        <!-- Filter Form to find more shipments -->
        <form asp-action="FilterShipments" method="post">
            <!-- This form is identical to the one in Create.cshtml -->
        </form>

        <!-- Add/Remove Shipments Section -->
        <hr />
        <h5>Add/Remove Shipments</h5>
        <input type="hidden" id="manifestDbId" value="@Model.ManifestDbId" />
        <div class="row mt-3">
            <div class="col-md-6 border-right">
                <h6>Available Shipments</h6>
                <table class="table table-sm table-hover">
                    <thead><tr><th>Waybill #</th><th>Date</th><th>Destination</th><th>Action</th></tr></thead>
                    <tbody id="availableTableBody">
                    @foreach(var item in Model.AvailableShipments) {
                        <tr><td>@item.WaybillNumber</td><td>@item.DateCreated.ToShortDateString()</td><td>@item.Destination</td><td><button class="btn btn-success btn-sm add-btn" data-waybill="@item.WaybillNumber">Add</button></td></tr>
                    }
                    </tbody>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Shipments on this Manifest</h6>
                <table class="table table-sm">
                    <thead><tr><th>Waybill #</th><th>Destination</th><th>Action</th></tr></thead>
                    <tbody id="manifestedTableBody">
                    @foreach(var item in Model.ManifestedShipments) {
                        <tr><td>@item.WaybillNumber</td><td>@item.Destination</td><td><button class="btn btn-danger btn-sm remove-btn" data-waybill="@item.WaybillNumber">Remove</button></td></tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="mt-3">
            <a asp-action="ManifestList" class="btn btn-primary">Done Editing</a>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function() {
            function handleManifestAction(button, url, targetTable, newButtonClass, newButtonText) {
                var row = button.closest('tr');
                var waybill = button.data('waybill');
                var manifestId = $('#manifestDbId').val();

                $.post(url, { manifestDbId: manifestId, waybillNumber: waybill }, function(response) {
                    if (response.success) {
                        row.detach().appendTo(targetTable);
                        button.removeClass().addClass(newButtonClass).text(newButtonText);
                    } else {
                        alert('Error: ' + response.message);
                    }
                });
            }

            $('#availableTableBody').on('click', '.add-btn', function() {
                handleManifestAction($(this), '@Url.Action("AddToManifest")', '#manifestedTableBody', 'btn btn-danger btn-sm remove-btn', 'Remove');
            });

            $('#manifestedTableBody').on('click', '.remove-btn', function() {
                handleManifestAction($(this), '@Url.Action("RemoveFromManifest")', '#availableTableBody', 'btn btn-success btn-sm add-btn', 'Add');
            });
        });
    </script>
}